@if (isOpen) {
  <div class="agent-panel-backdrop" (click)="onRequestClose()"></div>

  <section aria-label="Agent Chat Panel" class="agent-panel" role="dialog">
    <header class="agent-panel__header">
      <h2 class="mb-0">Agent</h2>
      <button
        aria-label="Close agent panel"
        mat-icon-button
        type="button"
        (click)="onRequestClose()"
      >
        <mat-icon>close</mat-icon>
      </button>
    </header>

    <div #messageContainer class="agent-panel__messages">
      @if (chatState().blocks.length === 0) {
        <p class="agent-panel__empty mb-0" i18n>
          Ask about your portfolio performance, allocation, transactions, or
          taxes.
        </p>
      }

      @for (block of chatState().blocks; track $index) {
        <div
          class="agent-panel__message-row"
          [class.agent-panel__message-row--assistant]="
            block.type === 'assistant'
          "
          [class.agent-panel__message-row--user]="block.type === 'user'"
        >
          @if (block.type === 'user') {
            <div class="agent-bubble agent-bubble--user">
              {{ block.content }}
            </div>
          }

          @if (block.type === 'assistant') {
            <div class="agent-bubble agent-bubble--assistant">
              {{ block.content }}

              @if (
                block.confidence != null ||
                block.toolsUsed != null ||
                block.verificationCount != null
              ) {
                <div class="agent-meta-summary">
                  @if (block.confidence != null) {
                    <span
                      class="agent-confidence-badge"
                      [class.agent-confidence-badge--high]="
                        block.confidence >= 0.8
                      "
                      [class.agent-confidence-badge--low]="
                        block.confidence < 0.5
                      "
                      [class.agent-confidence-badge--medium]="
                        block.confidence >= 0.5 && block.confidence < 0.8
                      "
                    >
                      {{ (block.confidence * 100).toFixed(0) }}% confidence
                    </span>
                  }
                  @if (block.toolsUsed != null) {
                    <span class="agent-meta-summary__item">
                      Tools: {{ block.toolsUsed }}
                    </span>
                  }
                  @if (block.verificationCount != null) {
                    <span class="agent-meta-summary__item">
                      Verification: {{ block.verificationCount }}
                    </span>
                  }
                </div>
              }

              @if (block.citations && block.citations.length > 0) {
                <details class="agent-citations">
                  <summary class="agent-citations__toggle">
                    Sources ({{ block.citations.length }})
                  </summary>
                  <ul class="agent-citations__list">
                    @for (citation of block.citations; track citation.label) {
                      <li class="agent-citations__item">
                        <span class="agent-citations__label">{{
                          citation.label
                        }}</span>
                        <span class="agent-citations__source">{{
                          citation.display_name
                        }}</span>
                        <span class="agent-citations__value">{{
                          citation.value
                        }}</span>
                      </li>
                    }
                  </ul>
                </details>
              }
            </div>
          }

          @if (block.type === 'thinking') {
            <gf-agent-thinking-block
              [message]="block.message || 'Analyzing your request...'"
            />
          }

          @if (block.type === 'tool_call') {
            <gf-agent-tool-call-block
              [args]="block.args || {}"
              [tool]="block.tool || 'unknown_tool'"
            />
          }

          @if (block.type === 'tool_result') {
            <gf-agent-tool-result-block
              [error]="block.error"
              [success]="!!block.success"
              [tool]="block.tool || 'unknown_tool'"
            />
          }

          @if (block.type === 'error') {
            <gf-agent-error-block
              [code]="block.code || ''"
              [message]="
                block.message || 'Received an error from the portfolio service.'
              "
            />
          }
        </div>
      }
    </div>

    <div class="agent-panel__suggestions">
      @for (question of sampleQuestions; track question) {
        <button
          class="agent-suggestion-chip"
          type="button"
          (click)="onSampleQuestionClick(question)"
        >
          {{ question }}
        </button>
      }
    </div>

    <footer class="agent-panel__composer">
      <mat-form-field appearance="outline" class="agent-panel__input">
        <mat-label i18n>Ask the agent</mat-label>
        <textarea
          data-testid="agent-chat-input"
          matInput
          placeholder="How is my portfolio doing ytd?"
          rows="2"
          [disabled]="chatState().isStreaming"
          [value]="draftMessage"
          (input)="onDraftMessageInput($event)"
          (keydown)="onInputKeyDown($event)"
        ></textarea>
      </mat-form-field>

      <div class="agent-panel__actions">
        @if (chatState().isStreaming) {
          <button
            data-testid="agent-cancel-button"
            mat-stroked-button
            type="button"
            (click)="onCancelStream()"
          >
            Cancel
          </button>
        }

        <button
          color="primary"
          data-testid="agent-send-button"
          mat-flat-button
          type="button"
          [disabled]="!canSendMessage"
          (click)="onSendMessage()"
        >
          Send
        </button>
      </div>
    </footer>
  </section>
}
